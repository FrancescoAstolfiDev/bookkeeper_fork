<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuditorElector.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache BookKeeper :: Server</a> &gt; <a href="index.source.html" class="el_package">org.apache.bookkeeper.replication</a> &gt; <span class="el_source">AuditorElector.java</span></div><h1>AuditorElector.java</h1><pre class="source lang-java linenums">/*
 *
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 *
 */
package org.apache.bookkeeper.replication;

import static org.apache.bookkeeper.replication.ReplicationStats.AUDITOR_SCOPE;

import com.google.common.annotations.VisibleForTesting;
import java.io.IOException;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.Future;
import java.util.concurrent.RejectedExecutionException;
import java.util.concurrent.ThreadFactory;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;
import java.util.concurrent.atomic.AtomicBoolean;
import org.apache.bookkeeper.client.BKException;
import org.apache.bookkeeper.client.BookKeeper;
import org.apache.bookkeeper.conf.ServerConfiguration;
import org.apache.bookkeeper.meta.LedgerAuditorManager;
import org.apache.bookkeeper.net.BookieId;
import org.apache.bookkeeper.replication.ReplicationException.UnavailableException;
import org.apache.bookkeeper.stats.NullStatsLogger;
import org.apache.bookkeeper.stats.StatsLogger;
import org.apache.bookkeeper.stats.annotations.StatsDoc;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Performing auditor election using Apache ZooKeeper. Using ZooKeeper as a
 * coordination service, when a bookie bids for auditor, it creates an ephemeral
 * sequential file (znode) on ZooKeeper and considered as their vote. Vote
 * format is 'V_sequencenumber'. Election will be done by comparing the
 * ephemeral sequential numbers and the bookie which has created the least znode
 * will be elected as Auditor. All the other bookies will be watching on their
 * predecessor znode according to the ephemeral sequence numbers.
 */
@StatsDoc(
    name = AUDITOR_SCOPE,
    help = &quot;Auditor related stats&quot;
)
public class AuditorElector {
<span class="nc" id="L63">    private static final Logger LOG = LoggerFactory</span>
<span class="nc" id="L64">            .getLogger(AuditorElector.class);</span>

    private final String bookieId;
    private final ServerConfiguration conf;
    private final BookKeeper bkc;
    private final boolean ownBkc;
    private final ExecutorService executor;
    private final LedgerAuditorManager ledgerAuditorManager;

    Auditor auditor;
<span class="nc" id="L74">    private AtomicBoolean running = new AtomicBoolean(false);</span>


    private final StatsLogger statsLogger;


    @VisibleForTesting
    public AuditorElector(final String bookieId, ServerConfiguration conf) throws UnavailableException {
<span class="nc" id="L82">        this(</span>
            bookieId,
            conf,
<span class="nc" id="L85">            Auditor.createBookKeeperClientThrowUnavailableException(conf),</span>
            true);
<span class="nc" id="L87">    }</span>

    /**
     * AuditorElector for performing the auditor election.
     *
     * @param bookieId
     *            - bookie identifier, comprises HostAddress:Port
     * @param conf
     *            - configuration
     * @param bkc
     *            - bookkeeper instance
     * @throws UnavailableException
     *             throws unavailable exception while initializing the elector
     */
    public AuditorElector(final String bookieId,
                          ServerConfiguration conf,
                          BookKeeper bkc,
                          boolean ownBkc) throws UnavailableException {
<span class="nc" id="L105">        this(bookieId, conf, bkc, NullStatsLogger.INSTANCE, ownBkc);</span>
<span class="nc" id="L106">    }</span>

    /**
     * AuditorElector for performing the auditor election.
     *
     * @param bookieId
     *            - bookie identifier, comprises HostAddress:Port
     * @param conf
     *            - configuration
     * @param bkc
     *            - bookkeeper instance
     * @param statsLogger
     *            - stats logger
     * @throws UnavailableException
     *             throws unavailable exception while initializing the elector
     */
    public AuditorElector(final String bookieId,
                          ServerConfiguration conf,
                          BookKeeper bkc,
                          StatsLogger statsLogger,
<span class="nc" id="L126">                          boolean ownBkc) throws UnavailableException {</span>
<span class="nc" id="L127">        this.bookieId = bookieId;</span>
<span class="nc" id="L128">        this.conf = conf;</span>
<span class="nc" id="L129">        this.bkc = bkc;</span>
<span class="nc" id="L130">        this.ownBkc = ownBkc;</span>
<span class="nc" id="L131">        this.statsLogger = statsLogger;</span>
        try {
<span class="nc" id="L133">            this.ledgerAuditorManager = bkc.getLedgerManagerFactory().newLedgerAuditorManager();</span>
<span class="nc" id="L134">        } catch (Exception e) {</span>
<span class="nc" id="L135">            throw new UnavailableException(&quot;Failed to instantiate the ledger auditor manager&quot;, e);</span>
<span class="nc" id="L136">        }</span>
<span class="nc" id="L137">        executor = Executors.newSingleThreadExecutor(new ThreadFactory() {</span>
                @Override
                public Thread newThread(Runnable r) {
<span class="nc" id="L140">                    return new Thread(r, &quot;AuditorElector-&quot; + bookieId);</span>
                }
            });
<span class="nc" id="L143">    }</span>

    public Future&lt;?&gt; start() {
<span class="nc" id="L146">        running.set(true);</span>
<span class="nc" id="L147">        return submitElectionTask();</span>
    }

    /**
     * Run cleanup operations for the auditor elector.
     */
    private Future&lt;?&gt; submitShutdownTask() {
<span class="nc" id="L154">        return executor.submit(shutdownTask);</span>
    }

<span class="nc" id="L157">    Runnable shutdownTask = new Runnable() {</span>
        @Override
        public void run() {
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (!running.compareAndSet(true, false)) {</span>
<span class="nc" id="L161">                return;</span>
            }

            try {
<span class="nc" id="L165">                ledgerAuditorManager.close();</span>
<span class="nc" id="L166">            } catch (InterruptedException ie) {</span>
<span class="nc" id="L167">                Thread.currentThread().interrupt();</span>
<span class="nc" id="L168">                LOG.warn(&quot;InterruptedException while closing ledger auditor manager&quot;, ie);</span>
<span class="nc" id="L169">            } catch (Exception ke) {</span>
<span class="nc" id="L170">                LOG.error(&quot;Exception while closing ledger auditor manager&quot;, ke);</span>
<span class="nc" id="L171">            }</span>
<span class="nc" id="L172">        }</span>
    };

    /**
     * Performing the auditor election using the ZooKeeper ephemeral sequential
     * znode. The bookie which has created the least sequential will be elect as
     * Auditor.
     */
    @VisibleForTesting
    Future&lt;?&gt; submitElectionTask() {

<span class="nc" id="L183">        Runnable r = new Runnable() {</span>
                @Override
                public void run() {
<span class="nc bnc" id="L186" title="All 2 branches missed.">                    if (!running.get()) {</span>
<span class="nc" id="L187">                        return;</span>
                    }
                    try {
<span class="nc" id="L190">                        ledgerAuditorManager.tryToBecomeAuditor(bookieId, e -&gt; handleAuditorEvent(e));</span>

<span class="nc" id="L192">                        auditor = new Auditor(bookieId, conf, bkc, false, statsLogger);</span>
<span class="nc" id="L193">                        auditor.start();</span>
<span class="nc" id="L194">                    } catch (InterruptedException e) {</span>
<span class="nc" id="L195">                        LOG.error(&quot;Interrupted while performing auditor election&quot;, e);</span>
<span class="nc" id="L196">                        Thread.currentThread().interrupt();</span>
<span class="nc" id="L197">                        submitShutdownTask();</span>
<span class="nc" id="L198">                    } catch (Exception e) {</span>
<span class="nc" id="L199">                        LOG.error(&quot;Exception while performing auditor election&quot;, e);</span>
<span class="nc" id="L200">                        submitShutdownTask();</span>
<span class="nc" id="L201">                    }</span>
<span class="nc" id="L202">                }</span>
            };
        try {
<span class="nc" id="L205">            return executor.submit(r);</span>
<span class="nc" id="L206">        } catch (RejectedExecutionException e) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            if (LOG.isDebugEnabled()) {</span>
<span class="nc" id="L208">                LOG.debug(&quot;Executor was already closed&quot;);</span>
            }
<span class="nc" id="L210">            return CompletableFuture.completedFuture(null);</span>
        }
    }

    private void handleAuditorEvent(LedgerAuditorManager.AuditorEvent e) {
<span class="nc bnc" id="L215" title="All 3 branches missed.">        switch (e) {</span>
            case SessionLost:
<span class="nc" id="L217">                LOG.error(&quot;Lost ZK connection, shutting down&quot;);</span>
<span class="nc" id="L218">                submitShutdownTask();</span>
<span class="nc" id="L219">                break;</span>

            case VoteWasDeleted:
<span class="nc" id="L222">                submitElectionTask();</span>
                break;
        }
<span class="nc" id="L225">    }</span>

    @VisibleForTesting
    Auditor getAuditor() {
<span class="nc" id="L229">        return auditor;</span>
    }


    public BookieId getCurrentAuditor() throws IOException, InterruptedException {
<span class="nc" id="L234">        return ledgerAuditorManager.getCurrentAuditor();</span>
    }

    /**
     * Shutting down AuditorElector.
     */
    public void shutdown() throws InterruptedException {
<span class="nc" id="L241">        synchronized (this) {</span>
<span class="nc bnc" id="L242" title="All 2 branches missed.">            if (executor.isShutdown()) {</span>
<span class="nc" id="L243">                return;</span>
            }
            // close auditor manager
            try {
<span class="nc" id="L247">                submitShutdownTask().get(10, TimeUnit.SECONDS);</span>
<span class="nc" id="L248">                executor.shutdown();</span>
<span class="nc" id="L249">            } catch (ExecutionException e) {</span>
<span class="nc" id="L250">                LOG.warn(&quot;Failed to close auditor manager&quot;, e);</span>
<span class="nc" id="L251">                executor.shutdownNow();</span>
<span class="nc" id="L252">                shutdownTask.run();</span>
<span class="nc" id="L253">            } catch (TimeoutException e) {</span>
<span class="nc" id="L254">                LOG.warn(&quot;Failed to close auditor manager in 10 seconds&quot;, e);</span>
<span class="nc" id="L255">                executor.shutdownNow();</span>
<span class="nc" id="L256">                shutdownTask.run();</span>
<span class="nc" id="L257">            }</span>
<span class="nc" id="L258">        }</span>

<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (auditor != null) {</span>
<span class="nc" id="L261">            auditor.shutdown();</span>
<span class="nc" id="L262">            auditor = null;</span>
        }
<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (ownBkc) {</span>
            try {
<span class="nc" id="L266">                bkc.close();</span>
<span class="nc" id="L267">            } catch (BKException e) {</span>
<span class="nc" id="L268">                LOG.warn(&quot;Failed to close bookkeeper client&quot;, e);</span>
<span class="nc" id="L269">            }</span>
        }
<span class="nc" id="L271">    }</span>

    /**
     * If current bookie is running as auditor, return the status of the
     * auditor. Otherwise return the status of elector.
     *
     * @return
     */
    public boolean isRunning() {
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (auditor != null) {</span>
<span class="nc" id="L281">            return auditor.isRunning();</span>
        }
<span class="nc" id="L283">        return running.get();</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L288">        return &quot;AuditorElector for &quot; + bookieId;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>